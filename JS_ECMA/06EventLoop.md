#### EventLoop

关注几个问题：

1. 什么是同步与异步？
2. `JavaScript`是一门单线程语言，那如何实现异步？
3. 同步任务和异步任务的执行顺序如何？
4. 异步任务是否存在优先级？
5. 每一轮 Event Loop 都会伴随着渲染吗？
6. `requestAnimationFrame` 在哪个阶段执行，在渲染前还是后？在 `microTask` 的前还是后？
7. `requestIdleCallback` 在哪个阶段执行？如何去执行？在渲染前还是后？在 `microTask` 的前还是后？
8. `resize`、`scroll` 这些事件是何时去派发的。

##### 一，什么是事件循环(EventLoop)机制？

`Event Loop`即事件循环，是浏览器或`Node`解决单线程运行时不会阻塞的一种机制，为了协调事件，用户交互，脚本，渲染，网络任务等。

`js`任务划分：

<img src="D:\work\gitRespository\note\JS_ECMA\img\js任务.webp" style="zoom:80%;" />

代码开始执行，创建一个全局调用栈，`script`作为宏任务执行

执行过程过同步任务立即执行，异步任务根据异步任务类型分别注册到微任务队列和宏任务队列

同步任务执行完毕，查看微任务队列

- 若存在微任务，将微任务队列全部执行(包括执行微任务过程中产生的新微任务,会添加到微任务队列)
- 若无微任务，查看宏任务队列，执行第一个宏任务，宏任务执行完毕，查看微任务队列，重复上述操作，直至宏任务队列为空



##### 二，流程

1. 从任务队列中取出一个**宏任务**并执行。

2. 检查微任务队列，执行并清空**微任务**队列，如果在微任务的执行中又加入了新的微任务，也会在这一步一起执行。

3. 进入更新渲染阶段，判断是否需要渲染，这里有一个 `rendering opportunity` 的概念，也就是说不一定每一轮 **event loop** 都会对应一次浏览 器渲染，要根据屏幕刷新率、页面性能、页面是否在后台运行来共同决定，通常来说这个渲染间隔是固定的。（所以多个 task 很可能在一次渲染之间执行）

   - 浏览器会尽可能的保持帧率稳定，例如页面性能无法维持 60fps（每 16.66ms 渲染一次）的话，那么浏览器就会选择 30fps 的更新速率，而不是偶尔丢帧。
   - 如果浏览器上下文不可见，那么页面会降低到 4fps 左右甚至更低。
   - 如果满足以下条件，也会跳过渲染：
     1. 浏览器判断更新渲染不会带来视觉上的改变。
     2. `map of animation frame callbacks` 为空，也就是帧动画回调为空，可以通过 `requestAnimationFrame` 来请求帧动画。

4. 如果上述的判断决定本轮**不需要渲染**，那么**下面的几步也不会继续运行**：

    有时候浏览器希望两次「定时器任务」是合并的，他们之间只会穿插着 `microTask`的执行，而不会穿插屏幕渲染相关的流程（比如`requestAnimationFrame`）。

5. 对于需要渲染的文档，如果窗口的大小发生了变化，执行监听的 `resize` 方法。

6. 对于需要渲染的文档，如果页面发生了滚动，执行 `scroll` 方法。

7. 对于需要渲染的文档，执行帧动画回调，也就是 **`requestAnimationFrame`** 的回调。

8. 对于需要渲染的文档， 执行 IntersectionObserver 的回调。

9. 对于需要渲染的文档，**重新渲染**绘制用户界面。

10. 判断 `task队列`和`microTask`队列是否都为空，如果是的话，则进行 `Idle` 空闲周期的算法，判断是否要执行 **`requestIdleCallback`** 的回调函数。

##### 三，未完待续