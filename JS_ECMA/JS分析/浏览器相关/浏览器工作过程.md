### 浏览器是如何工作的？

**浏览器是个多进程结构**

1. 浏览器进程:控制除标签页外的用户界面，包括地址，书签，后退，前进按钮等，以及负责与浏览器其他进程负责协调工作

2. 缓存进程

3. 网络进程  发起网络请求

4. 渲染器进程    渲染Tab  有可能会为每个标签页是一个渲染进程

5. GPU进程  渲染

6. 插件进程    内置插件

7. 浏览器的结构图

   ![浏览器结构](D:\work\note\JS_ECMA\JS分析\浏览器相关\img\浏览器结构.png)

**对浏览器开发者而言，网页渲染进程的过程**：

1. 浏览器使用HTTP协议或者HTTPS协议，通过网络请求进程向服务端请求页面，将请求结果通过IPC传给渲染器进程.

2. 渲染进程的主线程将请求回的HTML代码解析，构建成DOM树；

   在解析html标签时，遇到script标签，会解析加载执行JS，无法跳过（阻塞DOM解析）？因为浏览器并不知道JS会不会改变DOM，所以会在JS执行完之后，继续解析DOM,最后生成 DOM Tree(DOM树)。

   **将JS放在合适的位置，或者通过 async 或者 defer 异步加载 JS . **

3. 计算DOM树上的CSS的style；

4. layoutTree : dom+style 根据dom树和样式生成layoutTree；

   DOM Tree 和  layoutTree并不一致，因为DOM Tree 是解析html所得，并不关心样式，layoutTree是通过dom 和style 计算所得，并最终展示在浏览器上的。

   比如，**某dom设置了 display：none，DOM Tree 上会存在该节点，而layoutTree则不会有**；

   **在before伪类添加了 content 的元素则不会存在DOM Tree 上。**

5. paint  : 绘制  主线程通过遍历 Layout Tree生成绘制顺序表（Paint Record）；

   该表记录了绘制的顺序，比如 设置了 z-index 属性的元素。

6. laryer  : 布局  然后根据主进程将layoutTree 和绘制信息表传给合成器线程；

7. 合成器线程 - 将得到的信息分图层分成更小的图块；

8. 栅格线程 - 将更小的图块进行栅格化raster，存储在GPU中，返还给合成器线程draw quads图块信息  ；

9. Frame 合成器将栅格线程返回的图块合成帧通过IPC传送给给浏览器进程；

   **假如滚动页面，会生成新的合成器帧，再传给浏览器进程交给GPU渲染。**

10. 浏览器进程 ，收到一帧的图像后传给GPU进行渲染；



HTTP请求回来的内容，就产生了流式的数据，后续DOM构建，CSS计算，渲染，合成，绘制。都是尽可能的流式处理，而非等待上一步完成，在浏览网页时，才会逐步出现页面。

![浏览器运行流程简图](D:\work\note\JS_ECMA\JS分析\浏览器相关\img\浏览器运行流程简图.png)

重排：
	当改变dom的属性时，会重新进行样式计算，会重新布局和绘制；比如，div.style.width = '1000'px;
重绘：
	当改变颜色时，只会发生样式计算和绘制(layer);比如：div.style.color = "red";

优化重排，重绘：

requestAnimationFrame() 
会将主线程的任务分散到每一帧的间隔，暂停JS的执行，待下一帧动画执行完毕，再执行JS. 从而不影响动画的流程。
React Fiber
	react利用浏览器的空闲时间做优化
Transform
	会直接运行合成器线程和栅格线程，所以不会阻塞主线程的渲染；

### HTTP协议

HTTP协议基于TCP协议出现，在TCP基础上，规定了Request-Response 的模式，决定通讯必然由浏览器发起；



状态码解析：

* 1xx：临时回应，表示客户端请继续。浏览器拦截，上层应用不会知晓。
* 2xx：请求成功。200：请求成功。
* 3xx: 表示请求的目标有变化，希望客户端进一步处理。301&302：永久性与临时性跳转。304：跟客户端缓存没有更新。
* 4xx：客户端请求错误。403：无权限。404：表示请求的页面不存在。418：It’s a teapot. 这是一个彩蛋，来自 ietf 的一个愚人节玩笑。（超文本咖啡壶控制协议）
* 5xx：服务端请求错误。500：服务端错误。503：服务端暂时性错误，可以一会再试。



### 详述解析代码

浏览器通过HTTP或者HTTPS请求到网页后，会通过状态机进行词法分析，将字符流拆分为词（token）了。





#### 详述构建DOM树

解析，构建，包括css解析等，涉及编译原理





